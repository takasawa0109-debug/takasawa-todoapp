<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ToDoã‚¢ãƒ—ãƒª</title>

  <style>
    body {
      font-family: sans-serif;
      margin: 30px;
      text-align: center;
    }
	
	h1 {
	  color: #BA7D8A;
	  margin-bottom: 20px;
	  font-weight: 800;
	    }
		
	thead {
		background-color: #BA7D8A;
		color: white;
	}

    /* ãƒ•ã‚©ãƒ¼ãƒ  */
    .task-form {
      width: 300px;
      margin: 20px auto;
      text-align: left;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group input[type="text"],
    .form-group textarea {
      width: 100%;
      font-size: 14px;
      padding: 8px;
      box-sizing: border-box;
    }

    .form-group textarea {
      height: 50px;
      resize: vertical;
    }

    .task-form button {
      padding: 6px 12px;
      font-size: 14px;
	  font-weight: bold;
	  color: #444444;
      cursor: pointer;
      display: block;
      margin: 10px auto 0;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }

    th, td {
      padding: 5px;
      border: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
    }
	
	button {
	  background-color: #F2DFDF;
	  border: none;
	  padding: 6px 12px;
	  border-radius: 8px;
	  cursor: pointer;
	  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	  transition: 0.2s;
	}

	button:hover {
	  transform: scale(1.05);
	}
	

    /* ãƒ‰ãƒ©ãƒƒã‚°ç”¨ãƒãƒ³ãƒ‰ãƒ« */
    .drag-handle {
      cursor: grab;
      font-size: 20px;
      width: 30px;
      user-select: none;
    }
    .drag-handle:active {
      cursor: grabbing;
    }

    .details {
      display: none;
      color: #555;
      margin-top: 4px;
      font-size: 0.9em;
    }

	.toggle-btn {
	  padding: 0 4px;
	  border: none;
	  background: none;
	  cursor: pointer;
	  font-size: 12px;
	  line-height: 1;
	  color: #BA7D8A;
	}

    .action-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }

    /* å®Œäº†/æœªå®Œäº†ã‚¹ã‚¿ã‚¤ãƒ« */
    tr.incomplete {
      background-color: white;
      color: #000;
    }

    tr.completed {
      background-color: #999999;
      color: #555;
    }

    tr.completed span {
      text-decoration: line-through;
    }
  </style>

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <h1>ToDo</h1>

  <!-- æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form th:action="@{/tasks}" method="post" th:object="${newTask}" class="task-form">
    <div class="form-group">
      <input type="text" id="title" th:field="*{title}" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" required>
    </div>

    <div class="form-group">
      <textarea id="description" th:field="*{description}" placeholder="è©³ç´°ã‚’å…¥åŠ›" required></textarea>
    </div>

    <button type="submit">ï¸ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ï¸</button>
  </form>

  <!-- ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <table>
    <thead>
      <tr>
        <th></th>
        <th>å®Œäº†</th>
        <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
        <th>ä½œæˆæ—¥æ™‚</th>
        <th>å‰Šé™¤/ç·¨é›†</th>
      </tr>
    </thead>

    <tbody id="task-table-body">
      <tr th:each="task : ${tasks}" th:attr="data-id=${task.id}"
          th:class="${task.completed} ? 'completed' : 'incomplete'">
        <td class="drag-handle">â£¿</td>

        <td>
          <form th:if="${!task.completed}" class="complete-form" method="post">
            <button type="button" class="complete-btn">âœ”ï¸</button>
          </form>
          <form th:if="${task.completed}" class="uncomplete-form" method="post">
            <button type="button" class="uncomplete-btn">â†©</button>
          </form>
        </td>

        <td>
          <span th:text="${task.title}"></span>
          <button class="toggle-btn" onclick="toggleDetails(this)">â–¼</button>
          <div class="details" th:text="${task.description}"></div>
        </td>

        <td th:text="${#temporals.format(task.createdAt, 'yyyy/MM/dd HH:mm')}"></td>

        <td>
          <div class="action-buttons">
            <form th:action="@{'/tasks/' + ${task.id} + '/delete'}" method="post">
              <button type="submit">ğŸ—‘</button>
            </form>
            <form th:action="@{'/tasks/' + ${task.id} + '/edit'}" method="get">
              <button type="submit">ğŸ–Šï¸</button>
            </form>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- è©³ç´°è¡¨ç¤ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    function toggleDetails(btn) {
      const details = btn.nextElementSibling;
      const visible = details.style.display === 'block';
      details.style.display = visible ? 'none' : 'block';
      btn.textContent = visible ? 'â–¼' : 'â–²';
    }
  </script>

  <!-- ä¸¦ã³æ›¿ãˆå‡¦ç† -->
  <script>
    const tbody = document.getElementById("task-table-body");
    Sortable.create(tbody, {
      animation: 150,
      handle: ".drag-handle",
      onEnd: function () {
        const order = [];
        document.querySelectorAll("#task-table-body tr").forEach(row => {
          order.push(row.getAttribute("data-id"));
        });

        fetch("/tasks/reorder", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(order)
        });
      }
    });

    // å®Œäº†/æœªå®Œäº†ãƒœã‚¿ãƒ³å‡¦ç†ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    tbody.addEventListener("click", function(e) {
      const target = e.target;
      const row = target.closest("tr");
      if (!row) return;

      // å®Œäº†ãƒœã‚¿ãƒ³
      if (target.classList.contains("complete-btn")) {
        row.classList.remove("incomplete");
        row.classList.add("completed");

        fetch("/tasks/" + row.dataset.id + "/complete", { method: "POST" })
          .catch(err => console.error(err));

        // ãƒœã‚¿ãƒ³åˆ‡æ›¿
        const uncompleteBtn = document.createElement("button");
        uncompleteBtn.textContent = "â†©";
        uncompleteBtn.className = "uncomplete-btn";
        target.replaceWith(uncompleteBtn);
      }

      // æœªå®Œäº†ãƒœã‚¿ãƒ³
      if (target.classList.contains("uncomplete-btn")) {
        row.classList.remove("completed");
        row.classList.add("incomplete");

        fetch("/tasks/" + row.dataset.id + "/uncomplete", { method: "POST" })
          .catch(err => console.error(err));

        // ãƒœã‚¿ãƒ³åˆ‡æ›¿
        const completeBtn = document.createElement("button");
        completeBtn.textContent = "âœ”ï¸";
        completeBtn.className = "complete-btn";
        target.replaceWith(completeBtn);
      }
    });
  </script>
</body>
</html>
